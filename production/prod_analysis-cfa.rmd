---
title: "Analysis PPM-S"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
css: "../input/css/custom.css"
output:
  html_document:
    number_sections: true
    toc: true
    toc_float:
        collapsed: false
    toc_depth: 2
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

# Wave 01 {.tabset .tabset-fade .tabset-pills}

On the first wave of the study we conducted the application of the Perceptions and Preferences Meritocracy Scale (PPM-S), in which we decided to test three different modalities for the application of the scale. The design of the study considered a sample of 2200 cases in Chile, using quotas for sex, age and educational level. The most important feature of this study consists in that we randomly assigned the participants to three different groups, in which the subjects complete one of the three combination of the questions. The key feature of these combinations relies on the display order of the questions regarding to each indicator of the scale. On this respect, we have three subsamples that correspond to each application modality that can be analysed separately, but also all together as a full sample.

The scale has eight indicators, divided in four questions for perception and four for preferences, which are also divided in meritocratic and non-meritocratic. The meritocratic indicators refers to topics such as effort and talent, and the non-meritocratic refers to family wealth and networks. The three combinations relies in how these indicators are displayed to the respondent. The first combination corresponds to the group that answered the questions that were sorted by the Perceptions/Preferences dimension. the second combination corresponds to the group in which the questions are displayed following the a topic-sorted way, this means that the effort, talent, rich family and networks questions for perception and preference were displayed together. The last and third group corresponds to a completely randomized display order of the questions.                

The rationale of the design relies on the possibility to test how different display modalities could affect the hypothesized factor structure of the scale. On this regard, we conducted the analysis on two stages. On the first stage we tested the hypothesized factor structure on the three groups corresponding to each application modality and the full sample using a Confirmatory Factor Analysis (CFA). On the second stage, we conducted a Multi-group confirmatory factor analysis (MGCFA) using the groups created by the randomization. Furthermore, we explore the possibility of a second order factor structure, in which we tested two models. The first alternative corresponds to a second-order Confirmatory Factor Analysis assuming the Perception/Preference dimension as a second order factor. On the other hand, we tested a model in which we assume that the second order factor structure follows the Meritocratic/Non-meritocratic constructs.        

---

```{r}
table_format = if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
```


```{r eval=FALSE, include=FALSE}
rmarkdown::render(input = "production/prod_analysis-cfa.rmd",output_format = "html_document"); browseURL(url = "production/prod_analysis-cfa.html")
```

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
```

**Libraries**
```{r}
library(sjPlot)
library(dplyr)
library(lavaan)
library(semPlot)
library(stargazer)
library(corrplot)
library(psych)
library(knitr)
library(kableExtra)
library(rvest)
source('production/prod_polychoric.R')
```

**Load data**

```{r}
load(file = "input/data/proc/dat01.RData")
load(file = "input/data/proc/dat02.RData")
load(file = "input/data/proc/dat03.RData")
load(file = "input/data/proc/dat04.RData")
```


```{r eval=FALSE, include=FALSE}
data01 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola1.sav",verbose = FALSE)
dat01 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv01"))   %>% na.omit()
dat02 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv02"))   %>% na.omit()
dat03 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv03_p")) %>% na.omit()

# - Nos quedamos solamente con los casos que ACEPTARON participar y terminaron el cuestionario.
# - Para dejar una base que contenga solamente los casos que tienen información completa en los ítems usamos na.omit()

dat04 <- data01 %>% filter(Intro==1) %>%
  select(starts_with("meritv01"),
         starts_with("meritv02"),
         starts_with("meritv03_p"),
         starts_with("FL_21_DO"))
dat04$grupo <- NA
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v01==1] <- 1
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v02==1] <- 2
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v03==1] <- 3
dat04$perc_effort <- rowSums(dat04[,c(matches(match = "perc_effort",vars = names(dat04)))],na.rm = TRUE)
dat04$perc_talent <- rowSums(dat04[,c(matches(match = "perc_talent",vars = names(dat04)))],na.rm = TRUE)
dat04$perc_wpart  <- rowSums(dat04[,c(matches(match = "perc_wpart" ,vars = names(dat04)))],na.rm = TRUE)
dat04$perc_netw   <- rowSums(dat04[,c(matches(match = "perc_netw"  ,vars = names(dat04)))],na.rm = TRUE)

dat04$pref_effort <- rowSums(dat04[,c(matches(match = "pref_effort",vars = names(dat04)))],na.rm = TRUE)
dat04$pref_talent <- rowSums(dat04[,c(matches(match = "pref_talent",vars = names(dat04)))],na.rm = TRUE)
dat04$pref_wpart  <- rowSums(dat04[,c(matches(match = "pref_wpart" ,vars = names(dat04)))],na.rm = TRUE)
dat04$pref_netw   <- rowSums(dat04[,c(matches(match = "pref_netw"  ,vars = names(dat04)))],na.rm = TRUE)
dat04[dat04==0] <- NA
dat04 <- dat04 %>% select(starts_with(match = "perc_"),starts_with(match = "pref_"),grupo) %>% na.omit()
```

---

**Modality**

Each group correspond to the application modality of the scale.

1. **Version 01:** Fixed order by perception / preferences (N=`r dim(dat01)[1]`)

2. **Version 02:** Fixed order, by topic (N=`r dim(dat02)[1]`)

3. **Version 03:** Random order (N=`r dim(dat03)[1]`)

4. **Complete Sample:** Complete sample (N=`r dim(dat04)[1]`)

## Version 01 (N=`r dim(dat01)[1]`){.tabset}

| Spanish (original)          | English (translated)   |
|-----------------------------|------------------------|
| A. Percepción esfuerzo      | Perception effort      |
| B. Percepción talento       | Perception talent      |
| C. Percepción familia rica  | Perception rich family |
| D. Percepción redes         | Perception networks    |
| E. Preferencia esfuerzo     | Preference effort      |
| F. Preferencia talento      | Preference talent      |
| G. Preferencia familia rica | Preference rich family |
| H. Preferencia redes        | Preference networks    |
Table: Mode 01: Fixed order by perception

```{r echo=FALSE,results='asis'}
stargazer(dat01,type = "html",
          title = "Descriptive statistics",
          font.size = "small",
          median = TRUE,
          header=FALSE,
          digit.separator = "",
          digits = 2,
          covariate.labels = c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw"))
```

```{r correlacion v01}
cor01<-polychoric(dat01)
rownames(cor01$rho) <- c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw")
colnames(cor01$rho) <- c("(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)")
corrplot(cor01$rho,method = "color" ,type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
```


```{r}
model01 <- 'perc_merit=~perc_effort+perc_talent
            perc_nmerit=~perc_wpart+perc_netw
            pref_merit=~pref_effort+pref_talent
            pref_nmerit=~pref_wpart+pref_netw'

fit1_c <- cfa(model = model01,data = dat01,estimator="MLR") # Continuous/ estimator ML Robust

fit1_o <- cfa(model = model01,data = dat01,
            ordered = c("perc_effort","perc_talent",
                        "perc_wpart","perc_netw",
                        "pref_effort","pref_talent",
                        "pref_wpart","pref_netw"))

#---------------------------------------------------#
cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit1_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),y = standardizedsolution(fit1_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```

> **NOTE**: good fit, heywood case item 8.

```{r}
labs<- c("A. Who the more they try they manage to get bigger rewards that those who striveless.",
         "B. Who possess more talent they manage to obtain greater rewards than those who possess less talent.",
         "C. Who they have rich parents manage to get out ahead.",
         "D. Who they have good contacts they manage to get out ahead.",
         "E. Who the more they try they should get greater rewards than those who they try less." ,
         "F. Who possess more talent they should get greater rewards than those who possess less talent." ,
         "G. It's fine that those who have rich parents get ahead",
         "H. Is well that those who have good contacts get ahead." )
cnametab<- c("","(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)","(1)","(2)","(3)","(4)","(1)","(2)","(3)","(4)")
```


```{r tabla01, eval=TRUE, include=TRUE}
polyw01<- poly(sjlabelled::remove_all_labels(dat01),
               digits = 2,
               triangle = "l",
               fade.ns = F,
               remove.spaces = T,
               string.diag = c("$-$","$-$","$-$","$-$","$-$","$-$","$-$","$-$"))
matpolyw01 <- as.data.frame(read_html(x = polyw01[["page.content"]]) %>% html_table(fill=FALSE)) 
matpolyw01 <- matpolyw01[-c(9),]
colnames(matpolyw01) <- c("vars","(A)","(B)","(C)","(D)","(E)","(F)","(G)","(H)")

load01<- data.frame(round(cbind(inspect(fit1_c,what="std")$lambda,inspect(fit1_o,what="std")$lambda),digits = 2))
load01[load01==c(0.00)] <- NA; names(load01) <- c(1:4,1:4)

table01<- bind_cols(x = matpolyw01,y = load01)
# %>% mutate(vars=labs)

kable(table01,escape = TRUE,align = "l",col.names = cnametab,format = "html") %>% 
  footnote(general = paste0(paste0("$N$= ",nobs(fit1_c)),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>%
  add_header_above(c(" " = 1,"Polychoric correlations"=8, "MLR" = 4, "DWLS" = 4))%>%
  add_header_above(c(" " = 9,"Factor loadings"=8)) %>%
  column_spec(column = c(1),width ="7in",include_thead = T) %>%
  column_spec(column = c(2:17),width ="0.5in",include_thead = T) %>% 
  kable_styling(full_width = FALSE)
```

## Version 02  (N=`r dim(dat02)[1]`)

| Spanish (original)          | English (translated)   |
|-----------------------------|------------------------|
| A. Percepción esfuerzo      | Perception effort      |
| E. Preferencia esfuerzo     | Preference effort      |
| B. Percepción talento       | Perception talent      |
| F. Preferencia talento      | Preference talent      |
| C. Percepción familia rica  | Perception rich family |
| G. Preferencia familia rica | Preference rich family |
| D. Percepción redes         | Perception networks    |
| H. Preferencia redes        | Preference networks    |
Table: Mode 02: Fixed order, by topic.

```{r echo=FALSE,results='asis'}
stargazer(dat02,type = "html",
          title = "Descriptive statistics",
          font.size = "small",
          median = TRUE,
          header=FALSE,
          digit.separator = "",
          digits = 2,
          covariate.labels = c("A. pc.effort","E. pf.effort","B. pc.talent","F. pf.talent","C. pc.wpart","G. pf.wpart","D. pc.netw","H. pc.netw")) 
```

```{r}
cor02<-polychoric(dat02)
rownames(cor02$rho) <-c("A. pc.effort","E. pf.effort","B. pc.talent","F. pf.talent","C. pc.wpart","G. pf.wpart","D. pc.netw","H. pc.netw")
colnames(cor02$rho) <-c("(A)", "(E)","(B)","(F)","(C)","(G)","(D)", "(H)")
corrplot(cor02$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
``` 


```{r,results='hold'}
model02 <- 'perc_merit=~perc_effort+perc_talent
            perc_nmerit=~perc_wpart+perc_netw
            pref_merit=~pref_effort+pref_talent
            pref_nmerit=~pref_wpart+pref_netw'

fit2_c <- cfa(model = model02,data = dat02,estimator="MLR") # Continuous/ estimator ML Robust

fit2_o <- cfa(model = model02,data = dat02,ordered = c("perc_effort","perc_talent",
                                                       "perc_wpart"  ,"perc_netw",
                                                       "pref_effort" ,"pref_talent",
                                                       "pref_wpart"  ,"pref_netw"))

#---------------------------------------------------#
cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit2_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),y = standardizedsolution(fit2_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```
> **NOTE**: bad fit, heywood case using DWLS

```{r tabla02, echo=FALSE, include=TRUE}
polyw02<- poly(sjlabelled::remove_all_labels(dat02),
               digits = 2,
               triangle = "l",
               fade.ns = F,
               remove.spaces = T,
               string.diag = c("$-$","$-$","$-$","$-$","$-$","$-$","$-$","$-$"))
matpolyw02 <- as.data.frame(read_html(x = polyw02[["page.content"]]) %>% html_table(fill=FALSE)) 
matpolyw02 <- matpolyw02[-c(9),] 
colnames(matpolyw02) <- c("vars","(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)") 

load02<- data.frame(round(cbind(inspect(fit2_c,what="std")$lambda,inspect(fit2_o,what="std")$lambda),digits = 2))
load02[load02==c(0.00)] <- NA; names(load02) <- c(1:4,1:4)

table02<- bind_cols(x = matpolyw02,y = load02)
# %>% mutate(vars=labs)

kable(table02,escape = FALSE,align = "l",col.names = cnametab)  %>% 
  footnote(general = paste0(paste0("$N$= ",nobs(fit2_c)),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>%
  add_header_above(c(" " = 1,"Polychoric correlations"=8, "MLR" = 4, "DWLS" = 4))%>% 
  add_header_above(c(" " = 9,"Factor loadings"=8)) %>% 
  column_spec(column = c(1),width ="7in",include_thead = T) %>%
  column_spec(column = c(2:17),width ="0.5in",include_thead = T) %>% 
  kable_styling(full_width = FALSE) %>% 
  kable_styling(full_width = F)
```

## Version 03 (N=`r dim(dat03)[1]`)


| Spanish (original)          | English (translated)   |
|-----------------------------|------------------------|
| Orden aleatorio             | Randomized order       |

Table: Mode 03: Randomized order.

```{r echo=FALSE,results='asis'}
stargazer(dat03,type = "html",
          title = "Descriptive statistics",
          font.size = "small",
          median = TRUE,
          header=FALSE,
          digit.separator = "",
          digits = 2,
          covariate.labels = c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw"))
```

```{r}
cor03<-polychoric(dat03)
rownames(cor03$rho) <-c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw")
colnames(cor03$rho) <-c("(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)")
corrplot(cor03$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model03 <- '
perc_merit=~perc_effort+perc_talent
perc_nmerit=~perc_wpart+perc_netw
pref_merit=~pref_effort+pref_talent
pref_nmerit=~pref_wpart+pref_netw'

fit3_c <- cfa(model = model03,data = dat03,estimator="MLR",std.lv=FALSE) # Continuous/ estimator ML Robust

fit3_o <- cfa(model = model03,data = dat03,ordered = c("perc_effort","perc_talent",
                                                       "perc_wpart","perc_netw",
                                                       "pref_effort","pref_talent",
                                                       "pref_wpart","pref_netw"),std.lv=FALSE)
#---------------------------------------------------#
cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit3_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),y = standardizedsolution(fit3_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```

> **NOTE**: fit not very goood (RMSEA .7), no heywood. Try tau-equivalence

```{r}
polyw03<- poly(sjlabelled::remove_all_labels(dat03),
               digits = 2,
               triangle = "l",
               fade.ns = F,
               remove.spaces = T,
               string.diag = c("$-$","$-$","$-$","$-$","$-$","$-$","$-$","$-$"))
matpolyw03 <- as.data.frame(read_html(x = polyw03[["page.content"]]) %>% html_table(fill=FALSE)) 
matpolyw03 <- matpolyw03[-c(9),] 

colnames(matpolyw03) <- c("vars","(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)") 

load03<- data.frame(round(cbind(inspect(fit3_c,what="std")$lambda,inspect(fit3_o,what="std")$lambda),digits = 2))
load03[load03==c(0.00)] <- NA; names(load03) <- c(1:4,1:4)

table03<- bind_cols(x = matpolyw03,y = load03)
# %>% mutate(vars=labs)

kable(table03,escape = FALSE,align = "l",col.names = cnametab) %>% 
  footnote(general = paste0(paste0("$N$= ",nobs(fit3_c)),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>%
  add_header_above(c(" " = 1,"Polychoric correlations"=8, "MLR" = 4, "DWLS" = 4))%>% 
  add_header_above(c(" " = 9,"Factor loadings"=8)) %>% 
  column_spec(column = c(1),width ="7in",include_thead = T) %>%
  column_spec(column = c(2:17),width ="0.5in",include_thead = T) %>% 
  kable_styling(full_width = F)
```


### Tau-equivalence

```{r,results='hold'}
model03.tau <- '
perc_merit=~ r1*perc_effort+r1*perc_talent
perc_nmerit=~r2*perc_wpart+ r2*perc_netw
pref_merit=~ r3*pref_effort+r3*pref_talent
pref_nmerit=~r4*pref_wpart+ r4*pref_netw'

fit3_c.tau <- cfa(model = model03.tau,data = dat03,estimator="MLR",std.lv=FALSE) # Continuous/ estimator ML Robust

fit3_o.tau <- cfa(model = model03.tau,data = dat03,ordered = c("perc_effort","perc_talent",
                                                               "perc_wpart","perc_netw",
                                                               "pref_effort","pref_talent",
                                                               "pref_wpart","pref_netw"), std.lv=FALSE)
#---------------------------------------------------#
cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit3_c.tau ) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),y = standardizedsolution(fit3_o.tau) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames)
```

```{r}
kable(rbind(Ordinal    =fitmeasures(fit3_o    )[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
            Ordinal.tau=fitmeasures(fit3_o.tau)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]),
      format = "markdown",
      digits = 3, caption = "Fit tau-equivalence")
kable(anova(fit3_o,fit3_o.tau),
      format = "markdown",
      digits = 3)
```

<!-- > **NOTE:** El modelo con igualdad de cargas factoriales (en Percepción meritocracia) no deteriora significativamente el ajuste del modelo. -->

> **NOTE:** The model with equal factor loadings (in Meritocracy Perception) does not significantly deteriorate the model fit.

```{r tabla03, include=FALSE}
polyw03tau<- poly(sjlabelled::remove_all_labels(dat03),
               digits = 2,
               triangle = "l",
               fade.ns = F,
               remove.spaces = T,
               string.diag = c("$-$","$-$","$-$","$-$","$-$","$-$","$-$","$-$"))
matpolyw03tau <- as.data.frame(read_html(x = polyw03tau[["page.content"]]) %>% html_table(fill=FALSE)) 
matpolyw03tau <- matpolyw03tau[-c(9),] 

colnames(matpolyw03tau) <- c("vars","(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)") 
load03tau<- data.frame(round(cbind(inspect(fit3_c.tau,what="std")$lambda,inspect(fit3_o.tau,what="std")$lambda),digits = 2))
load03tau[load03tau==c(0.00)] <- NA; names(load03tau) <- c(1:4,1:4)

table03tau<- bind_cols(x = matpolyw03tau,y = load03tau) 
# %>% mutate(vars=labs)

kable(table03tau,escape = FALSE,align = "l",col.names = cnametab) %>% 
  footnote(general = paste0(paste0("$N$= ",nobs(fit3_c.tau)),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>%
  add_header_above(c(" " = 1,"Polychoric correlations"=8, "MLR" = 4, "DWLS" = 4))%>% 
  add_header_above(c(" " = 9,"Factor loadings"=8)) %>% 
  column_spec(column = c(1),width ="7in",include_thead = T) %>%
  column_spec(column = c(2:17),width ="0.5in",include_thead = T) %>% 
  kable_styling(full_width = F)
```


## Complete sample (N=`r dim(dat04)[1]`)

| Spanish (original)                           | English (translated)                 |
|----------------------------------------------|--------------------------------------|
| Orden fijo, según percepción/preferencia     | Fixed order, by perception/preference|
| Orden fijo, por tópico                       | Fixed order, by topic.               |
| Orden aleatorizado                           | Randomized order                     |
Table: Mode 04: Complete sample

```{r echo=FALSE,results='asis'}
stargazer(select(dat04,perc_effort,perc_talent,perc_wpart,perc_netw,pref_effort,pref_talent,pref_wpart,pref_netw),
          type = "html",
          title = "Descriptive statistics",
          font.size = "small",
          median = TRUE,
          header=FALSE,
          digit.separator = "",
          digits = 2,
          covariate.labels = c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw"))
```

```{r}
cor04<-polychoric(select(dat04,perc_effort,perc_talent,perc_wpart,perc_netw,pref_effort,pref_talent,pref_wpart,pref_netw))
rownames(cor04$rho) <-c("A. pc.effort", "B. pc.talent","C. pc.wpart","D. pc.netw","E. pf.effort","F. pf.talent","G. pf.wpart", "H. pf.netw")
colnames(cor04$rho) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)", "(H)")
save(cor04, file = "output/images/correlation.RData")
corrplot(cor04$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model04 <- '
perc_merit =~ perc_effort+perc_talent
perc_nmerit=~perc_wpart +perc_netw
pref_merit =~ pref_effort+pref_talent
pref_nmerit=~pref_wpart +pref_netw'

fit4_c <- cfa(model = model04,data = dat04,estimator="MLR",std.lv=FALSE) # Continuous/ estimator ML Robust

fit4_o <- cfa(model = model04,data = dat04,ordered = c("perc_effort","perc_talent",
                                                       "perc_wpart","perc_netw",
                                                       "pref_effort","pref_talent",
                                                       "pref_wpart","pref_netw"),std.lv=FALSE)
#---------------------------------------------------#
cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit4_c ) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),y = standardizedsolution(fit4_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```

```{r tabla04, include=FALSE}
polyw04<- poly(sjlabelled::remove_all_labels(dat04[,-c(1)]),
               digits = 2,
               triangle = "l",
               fade.ns = F,
               remove.spaces = T,
               string.diag = c("$-$","$-$","$-$","$-$","$-$","$-$","$-$","$-$"))
matpolyw04 <- as.data.frame(read_html(x = polyw04[["page.content"]]) %>% html_table(fill=FALSE)) 
matpolyw04 <- matpolyw04[-c(9),] 

colnames(matpolyw04) <- c("vars","(A)","(B)","(C)","(D)","(E)","(F)","(G)", "(H)") 
load04<- data.frame(round(cbind(inspect(fit4_c,what="std")$lambda,inspect(fit4_o,what="std")$lambda),digits = 2))
load04[load04==c(0.00)] <- NA; names(load04) <- c(1:4,1:4)

table04<- bind_cols(x = matpolyw04,y = load04) 
# %>% mutate(vars=labs)

kable(table04,escape = FALSE,align = "l",col.names = cnametab) %>% 
  footnote(general = paste0(paste0("$N$= ",nobs(fit4_c)),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>%
  add_header_above(c(" " = 1,"Polychoric correlations"=8, "MLR" = 4, "DWLS" = 4))%>% 
  add_header_above(c(" " = 9,"Factor loadings"=8)) %>% 
  column_spec(column = c(1),width ="7in",include_thead = T) %>%
  column_spec(column = c(2:17),width ="0.5in",include_thead = T) %>% 
  kable_styling(full_width = F)
```

# Tables 

```{r tb_desc-corr}
load04<- data.frame(round(inspect(fit4_o,what="std")$lambda,digits = 2))
load04[load04==c(0.00)] <- NA; names(load04) <- c(1:4)

colnames(matpolyw04) <- c("Variable","A","B","C","D","E","F","G", "H") 

sum04b  <- psych::describe(dat04[,-c(1)], fast = T) %>% select(mean,sd,min,max) %>% data.frame() %>% round(digits = 2)
table04b<- bind_cols(x = sum04b,y = matpolyw04) %>% select(Variable, everything()) %>% mutate(Variable=labs) %>% rename("Mean"=mean, "SD"=sd, "Min"=min,"Max"=max)

cap01 <- "Descriptive statistic"
sumdat04<- kable(table04b, escape = FALSE,align = "l",linesep = "", caption = cap01) %>% 
           column_spec(column = 1,width = "10cm",width_min = "12cm",include_thead = TRUE) %>% 
           footnote(general = paste0(paste0("$N$= ","2141"),"; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$"),footnote_as_chunk = T) %>% 
           add_header_above(header = c(" "=5,"Polychoric correlations"= 8)) %>% 
           kable_styling(full_width = TRUE,font_size = 8,position = "center");sumdat04
save(sumdat04,file = "output/tables/sumdat04.RData")
```

```{r tb_loads-fitm}
tb.load<- data.frame(round(cbind(inspect(fit1_o,what="std")$lambda,
                                 inspect(fit2_o,what="std")$lambda,
                                 inspect(fit3_o,what="std")$lambda),
                           digits = 2))
tb.load[tb.load==c(0.00)] <- NA; names(tb.load) <- c(paste0("M1.",1:4),paste0("M2.",1:4),paste0("M3.",1:4))

for (i in names(tb.load)) {
  # tb.load[,i] <- sjlabelled::as_character(tb.load[,i])
  tb.load[,i] <- sprintf(tb.load[,i], fmt = '%#.2f')
}
tb.load[tb.load=="NA"] <- ""

#-------#
fm01<- data.frame(t(data.frame(fitmeasures(fit1_o, output ="matrix")[c("chisq.scaled","df","cfi.scaled","rmsea.scaled"),]))); row.names(fm01) ="M1.1"
fm02<- data.frame(t(data.frame(fitmeasures(fit2_o, output ="matrix")[c("chisq.scaled","df","cfi.scaled","rmsea.scaled"),]))); row.names(fm02) ="M2.1"
fm03<- data.frame(t(data.frame(fitmeasures(fit3_o, output ="matrix")[c("chisq.scaled","df","cfi.scaled","rmsea.scaled"),]))); row.names(fm03) ="M3.1"

#------chi2, df------#
fm04<- round(rbind(fm01,fm02,fm03),3)
fm04.1 <- fm04 %>% select(chisq.scaled,df) 
fm04.1$chisq.scaled <- round(x = fm04.1$chisq.scaled,digits = 2)
fm04.1$df <- round(x = fm04.1$df,digits = 0)
fm04.1$chi2df <- paste0(fm04.1$chisq.scaled,"(",fm04.1$df,")")
fm04.1 <- select(fm04.1,"chi2df")
for (i in names(fm04.1)) {
  fm04.1[,i] <- as.character(fm04.1[,i])
}

#------CFI, RMSEA------#
fm04.2 <- fm04 %>% select(cfi.scaled,rmsea.scaled) 
for (i in names(fm04.2)) {
  fm04.2[,i] <- sprintf(fm04.2[,i], fmt = '%#.3f')
}

fm.df      <- bind_cols(fm04.1,fm04.2)
fm.df$nobs <- c(nobs(fit1_o),nobs(fit2_o),nobs(fit3_o)) 
fm.df <- data.frame(t(fm.df)); colnames(fm.df) <- c("M1.2","M2.2","M3.2")


#------ merge ------#
tb.fm<- bind_rows(tb.load,fm.df)
tb.fm<- tb.fm %>% mutate(vars=c(labs,"$\\chi^2\\text{(df)}$","$\\text{CFI}$","$\\text{RMSEA}$","$N$")) %>% select(vars,everything())
#--table---#
tb.col  <- c("Variables",1:4,1:4,1:4)
tb.foot <- paste0("; p<0.05=$*$; p<0.01=$**$; p<0.001=$***$. Standardised factor loadings using DWLS estimator. CFI = Comparative fit index (scaled), RMSEA = Root mean square error of approximation (scaled)")
tb.caption <- "Factor loadings and fit measures" 

tb.fm01<- kable(tb.fm,escape = FALSE,align = "lcccccccccccc",col.names = tb.col, caption = tb.caption) %>% 
          kable_styling(full_width = F,font_size = 9) %>% 
          column_spec(column = 1,width = "10cm",width_min = "12cm",include_thead = TRUE) %>% 
          column_spec(column = 2:13,width = "1cm",width_min = "1.3cm",include_thead = TRUE) %>% 
          add_header_above(header = c(" "=1,"Version 1"= 4,"Version 2"= 4,"Version 3"= 4)) %>% 
          add_header_above(header = c(" "=1,"Factor loadings"= 12)) %>% 
          row_spec(row = 8,hline_after = TRUE) %>%
          add_indent(c(9:12)) %>% 
          footnote(general =tb.foot ,footnote_as_chunk = T);tb.fm01
save(tb.fm01,file = "output/tables/tb.fm01.RData")


save(tb.fm,file = "output/tables/tb.fm.RData")
save(fm.df,file = "output/tables/fm.df.RData")
save(tb.load,file = "output/tables/tb.load.RData")




```

# Summary

## Correlations plots

```{r compare corr, echo=TRUE, out.width=c('33%', '33%', '33%'),fig.cap="Mode 01, 02 and 03",fig.show='hold'}
corrplot(cor01$rho,method = "color" ,type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
corrplot(cor02$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
corrplot(cor03$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE)
```

## Measurement model

```{r semPlot, fig.cap="Measurement model PPM-S", fig.height=8, fig.width=12}
model01 <- 'perc_merit=~perc_effort+perc_talent
            perc_nmerit=~perc_wpart+perc_netw
            pref_merit=~pref_effort+pref_talent
            pref_nmerit=~pref_wpart+pref_netw'

plot01 <- cfa(model = model01,data = dat01,estimator="MLR",std.lv=TRUE)

nodeNames <-c("Perception effort","Perception talent","Perception rich family","Perception networks",
              "Preference effort","Preference talent","Preference rich family","Preference networks",
              "Perception meritocratic","Perception non meritocratic","Preference meritocratic","Preference non meritocratic")

dir.create("output/images")

semPaths(plot01,
         style = "lisrel",
         fade=FALSE,
         edge.color = "black",
         nCharNodes = 0,
         curvePivot = FALSE,
         curve = 2,
         rotation = 4,
         layout = "tree3",
         cardinal = "lat cov",
         legend.cex = 0.6,
         label.cex =1,
         reorder = FALSE,
         nodeNames = nodeNames,
         nodeLabels = c("A","B","C","D","E","F","G","H","1","2","3","4"),
         label.font = 6,
         edge.label.font= 1,
         asize = 3, #arrow size
         edge.width =1,
         sizeMan=5,
         sizeLat = 10,
         filetype ="png",
         width = 12,
         height= 10,
         filename = "output/images/meas01")
```


![](../output/images/meas01.png)

## Fit indices wave 01
```{r}
sum_fit<- bind_rows(fitmeasures(fit1_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit1_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit2_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit2_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit3_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit3_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit4_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit4_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")])
sum_fit$mod <- c("Model 1","Model 1","Model 2","Model 2","Model 3","Model 3","Model 4","Model 4")
sum_fit$est <- c("MLR","DWLS","MLR","DWLS","MLR","DWLS","MLR","DWLS")
sum_fit <- select(sum_fit,mod,est,everything())
colnames <- c("Model","Estimator","$\\chi^2$","df","CFI","CFI.sca","CFI.rob","RMSEA","RMSEA.sca","RMSEA.rob")


sumtable01<- kable(sum_fit,digits = 3,format = "html",row.names = F,booktabs=T, caption = "Summary fit indices wave 01",col.names = colnames,escape = FALSE) %>%
  kable_styling(full_width = F)  %>%
      collapse_rows(columns = 1,valign = "middle")  %>%
      footnote(number = c("Model 1: fixed order by percepction/preference",
                          "Model 2: fixed order by topic (i.e: effort)",
                          "Model 3: Randomized order",
                          "Model 4: Complete sample"));sumtable01

# Save sumamry table wave 01------------------------------#
# as_image(sumtable01,file = "output/sumtablew01.png")
# save_kable(sumtable01,file = "output/tables/sumtablew01.html",self_contained = FALSE)
```

## Other analyses

### Multigroup CFA

* The group specification correspond to the application modality of the scale.

```{r}
model04 <- '
perc_merit =~ perc_effort + perc_talent
perc_nmerit=~ perc_wpart  + perc_netw
pref_merit =~ pref_effort + pref_talent
pref_nmerit=~ pref_wpart  + pref_netw'

fit4_c_mg <- cfa(model = model04,data = dat04,estimator="MLR",std.lv=FALSE,group = "grupo") # Continuous/ estimator ML Robust
fit4_o_mg <- cfa(model = model04,data = dat04,ordered = c("perc_effort","perc_talent",
                                                          "perc_wpart","perc_netw",
                                                          "pref_effort","pref_talent",
                                                          "pref_wpart","pref_netw"),std.lv=FALSE, group = "grupo")
#---------------------------------------------------#
kable(rbind(Continuous=fitmeasures(fit4_c_mg)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
            Ordinal=  fitmeasures(fit4_o_mg)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]),
      format = "markdown",digits = 3,caption = "Fit indices")
gr01=standardizedsolution(fit4_c_mg) %>% filter(op=="=~") %>% select(group,lhs,rhs,est.std)
gr02=standardizedsolution(fit4_o_mg) %>% filter(op=="=~") %>% select(group,lhs,rhs,est.std)
gr01$group=dplyr::recode(gr01$group, `1` = "mod03", `2` = "mod02", `3` = "mod01")
gr02$group=dplyr::recode(gr02$group, `1` = "mod03", `2` = "mod02", `3` = "mod01")

cnames <- c("Grupo","Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x =gr01 ,
                y =gr02 ,
                c("group","lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames,caption = "Factor loadings by group")
```

### Second order CFA

#### SO-CFA Perception and Preference

```{r}
model04b1or <- '
perc_merit=~ perc_effort+perc_talent
perc_nmerit=~perc_wpart +perc_netw
pref_merit=~ pref_effort+pref_talent
pref_nmerit=~pref_wpart +pref_netw
percep=~ perc_merit + perc_nmerit
prefer=~ pref_merit + pref_nmerit'

fit4a_c <- cfa(model = model04b1or,data = dat04, estimator="MLR")

fit4b_c <- cfa(model = model04b1or,data = dat04,ordered = c("perc_effort","perc_talent","perc_wpart","perc_netw",
                                                            "pref_effort","pref_talent","pref_wpart","pref_netw"))

#---------------------------------------------------#
kable(rbind(Continuous=fitmeasures(fit4a_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
            Ordinal= fitmeasures(fit4b_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]),
      format = "markdown",digits = 3)

cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(fit4a_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),
                y = standardizedsolution(fit4b_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),
                c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames,caption = "Factor loadings")
```

> **NOTE:** Second order factor loads are low. The fit of the model is not good.

#### SO-CFA Meritocratic y Non-meritocratic

```{r}
model04b2or <-'perc_merit=~ perc_effort+perc_talent
               perc_nmerit=~perc_wpart +perc_netw
               pref_merit=~ pref_effort+pref_talent
               pref_nmerit=~pref_wpart +pref_netw
               merit =~ perc_merit  + pref_merit
               nmerit=~ perc_nmerit + pref_nmerit'

# fit4b_c <- cfa(model = model04b2or,data = dat04,estimator="MLR") # No converge

fit4b_o <- cfa(model = model04b2or,data = dat04,
               ordered = c("perc_effort","perc_talent","perc_wpart","perc_netw",
                           "pref_effort","pref_talent","pref_wpart","pref_netw"))

#---------------------------------------------------#
kable(rbind(Ordinal=fitmeasures(fit4b_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]),
      format = "markdown",digits = 3)

cnames <- c("Factor","Indicator","Loading (DWLS)")
kable(standardizedsolution(fit4b_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std),
      format = "markdown",digits = 2,col.names = cnames,caption = "Factor loadings")
```

> **NOTE:**  The model estimated with MLR with second order factors "meritocracy / non meritocracy" does not converge. The model estimated through DWLS converges, has very low loads and a very high one (merit ~ pref_merit). Fit is bad (RMSEA> .10)


<!-- # Wave 02 {.tabset .tabset-fade .tabset-pills} -->


<!-- Each sample correspond to one of the three conditions generated by the randomized assignment. -->

<!-- 1. **Control group:** the group that has been assigned to the control group (placebo condition) -->

<!-- 2. **Poverty condition sample** the group that has been assigned to the Poverty treatment condition. -->

<!-- 3. **Inequality condition sample:** the group that has been assigned to the Inequality treatment condition. -->

<!-- 4. **Complete sample:** Control, Poverty and Inequality treatment. -->


<!-- ```{r} -->
<!-- data02 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola2.sav",verbose = FALSE) -->
<!-- load(file = "input/data/proc/datawide.RData") -->
<!-- dat01 <- data02 %>% select(starts_with("meritv03_p")) -->
<!-- ``` -->

<!-- **ATE on observed indicators** -->

<!-- ```{r, out.width="75%",results='asis'} -->
<!-- m01<- lm(perc_effort_w2~treat,data = wide01) -->
<!-- m02<- lm(perc_talent_w2~treat,data = wide01) -->
<!-- m03<- lm(perc_wpart_w2~treat, data = wide01) -->
<!-- m04<- lm(perc_netw_w2~treat,  data = wide01) -->
<!-- #--------------------------------------------# -->
<!-- m05<- lm(pref_effort_w2~treat,data = wide01) -->
<!-- m06<- lm(pref_talent_w2~treat,data = wide01) -->
<!-- m07<- lm(pref_wpart_w2 ~treat, data = wide01) -->
<!-- m08<- lm(pref_netw_w2  ~treat,  data = wide01) -->
<!-- #--------------------------------------------# -->
<!-- stargazer::stargazer(m01,m02,m03,m04,type = "html") -->
<!-- stargazer::stargazer(m05,m06,m07,m08,type = "html") -->
<!-- ``` -->

<!-- > **NOTE**: There are no statistically significant effects of the treatment conditions on the observed indicators of the meritocracy scale. -->


<!-- ## Control group -->

<!-- ```{r} -->
<!-- w02con <- data02 %>% filter(FL_6_DO_Control==1) %>% select(starts_with("meritv03_p")) -->
<!-- ``` -->

<!-- ```{r results='asis'} -->
<!-- stargazer(w02con,type = "html", -->
<!--           title = "Descriptive statistics", -->
<!--           font.size = "small", -->
<!--           median = TRUE, -->
<!--           header=FALSE, -->
<!--           digit.separator = "", -->
<!--           digits = 2) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- corw02_1<-polychoric(w02con) -->
<!-- rownames(corw02_1$rho) <-c("1. pc_effort", "2. pc_talent","3. pc_wpart","4. pc_netw","5. pf_effort","6. pf_talent","7. pf_wpart", "8. pf_netw") -->
<!-- colnames(corw02_1$rho) <-c("(1)", "(2)","(3)","(4)","(5)","(6)","(7)", "(8)") -->
<!-- corrplot(corw02_1$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE) -->
<!-- ``` -->


<!-- ```{r,results='hold'} -->
<!-- model03 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw' -->

<!-- fitw02a_c <- cfa(model = model03,data = w02con,estimator="MLR") # Continuous/ estimator ML Robust -->

<!-- fitw02a_o <- cfa(model = model03,data = w02con,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                            "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                            "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                            "meritv03_pref_wpart","meritv03_pref_netw")) -->
<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Continuous=fitmeasures(fitw02a_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--             Ordinal= fitmeasures(fitw02a_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)") -->
<!-- kable(left_join(x = standardizedsolution(fitw02a_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 y = standardizedsolution(fitw02a_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 c("lhs","rhs")), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->

<!-- ## Poverty condition -->

<!-- ```{r} -->
<!-- w02pob <- data02 %>% filter(FL_6_DO_Tratamiento==1) %>% select(starts_with("meritv03_p")) -->
<!-- ``` -->

<!-- ```{r results='asis'} -->
<!-- stargazer(w02pob,type = "html", -->
<!--           title = "Descriptive statistics", -->
<!--           font.size = "small", -->
<!--           median = TRUE, -->
<!--           header=FALSE, -->
<!--           digit.separator = "", -->
<!--           digits = 2) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- corw02_2<-polychoric(w02pob) -->
<!-- rownames(corw02_2$rho) <-c("1. pc_effort", "2. pc_talent","3. pc_wpart","4. pc_netw","5. pf_effort","6. pf_talent","7. pf_wpart", "8. pf_netw") -->
<!-- colnames(corw02_2$rho) <-c("(1)", "(2)","(3)","(4)","(5)","(6)","(7)", "(8)") -->
<!-- corrplot(corw02_2$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE) -->
<!-- ``` -->

<!-- ```{r,results='hold'} -->
<!-- model03 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw' -->

<!-- fitw02b_c <- cfa(model = model03,data = w02pob,estimator="MLR") # Continuous/ estimator ML Robust -->

<!-- fitw02b_o <- cfa(model = model03,data = w02pob,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                            "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                            "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                            "meritv03_pref_wpart","meritv03_pref_netw")) -->

<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Continuous=fitmeasures(fitw02b_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--             Ordinal= fitmeasures(fitw02b_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)") -->
<!-- kable(left_join(x = standardizedsolution(fitw02b_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 y = standardizedsolution(fitw02b_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 c("lhs","rhs")), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->

<!-- ## Inequality condition -->

<!-- ```{r} -->
<!-- w02des <- data02 %>% filter(FL_6_DO_Tratamiento_desigualdad==1) %>% select(starts_with("meritv03_p")) -->
<!-- ``` -->

<!-- ```{r results='asis'} -->
<!-- stargazer(w02des,type = "html", -->
<!--           title = "Descriptive statistics", -->
<!--           font.size = "small", -->
<!--           median = TRUE, -->
<!--           header=FALSE, -->
<!--           digit.separator = "", -->
<!--           digits = 2) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- corw02_3<-polychoric(w02des) -->
<!-- rownames(corw02_3$rho) <-c("1. pc_effort", "2. pc_talent","3. pc_wpart","4. pc_netw","5. pf_effort","6. pf_talent","7. pf_wpart", "8. pf_netw") -->
<!-- colnames(corw02_3$rho) <-c("(1)", "(2)","(3)","(4)","(5)","(6)","(7)", "(8)") -->
<!-- corrplot(corw02_3$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE) -->
<!-- ``` -->

<!-- ```{r,results='hold'} -->
<!-- model03 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw' -->

<!-- fitw02c_c <- cfa(model = model03,data = w02des,estimator="MLR") # Continuous/ estimator ML Robust -->

<!-- fitw02c_o <- cfa(model = model03,data = w02des,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                            "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                            "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                            "meritv03_pref_wpart","meritv03_pref_netw")) -->
<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Continuous=fitmeasures(fitw02c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--             Ordinal= fitmeasures(fitw02c_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)") -->
<!-- kable(left_join(x = standardizedsolution(fitw02c_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 y = standardizedsolution(fitw02c_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 c("lhs","rhs")), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->

<!-- ## Complete sample -->

<!-- ```{r results='asis'} -->
<!-- stargazer(dat01,type = "html", -->
<!--           title = "Descriptive statistics", -->
<!--           font.size = "small", -->
<!--           median = TRUE, -->
<!--           header=FALSE, -->
<!--           digit.separator = "", -->
<!--           digits = 2) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dat01cor<- select(dat01,meritv03_perc_effort,meritv03_perc_talent, -->
<!--                         meritv03_perc_wpart,meritv03_perc_netw, -->
<!--                         meritv03_pref_effort,meritv03_pref_talent, -->
<!--                         meritv03_pref_wpart,meritv03_pref_netw) -->
<!-- cor01<-polychoric(dat01cor) -->
<!-- rownames(cor01$rho) <-c("1. pc_effort", "2. pc_talent","3. pc_wpart","4. pc_netw","5. pf_effort","6. pf_talent","7. pf_wpart", "8. pf_netw") -->
<!-- colnames(cor01$rho) <-c("(1)", "(2)","(3)","(4)","(5)","(6)","(7)", "(8)") -->
<!-- corrplot(cor01$rho,method = "color", type = "upper", tl.col = "black", addCoef.col = "black",diag = FALSE) -->
<!-- ``` -->

<!-- ```{r,results='hold'} -->
<!-- model03 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw' -->

<!-- fitw02_c <- cfa(model = model03,data = dat01,estimator="MLR",std.lv=FALSE) # Continuous/ estimator ML Robust -->

<!-- fitw02_o <- cfa(model = model03,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                          "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                          "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                          "meritv03_pref_wpart","meritv03_pref_netw")) -->
<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Continuous=fitmeasures(fitw02_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--             Ordinal= fitmeasures(fitw02_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)") -->
<!-- kable(left_join(x = standardizedsolution(fitw02_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 y = standardizedsolution(fitw02_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 c("lhs","rhs")), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->

<!-- > **NOTE**: El ajuste de muestra completa en wave 02 con estimator MLR (robusto) es bastante bueno (CFI, RMSEA). El ajuste con DWLS es bastante bueno, CFI mejora, RMSEA aumenta un poco (0.59). -->

<!-- ### Second order CFA -->

<!-- ```{r} -->
<!-- modw2 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw -->
<!-- merit =~perc_merit+pref_merit -->
<!-- nmerit=~perc_nmerit+pref_nmerit' -->

<!-- # mod2_merit_c <- cfa(model = modw2,data = dat01) # Continuous/ estimator ML Robust -->

<!-- mod2_merit_o <- cfa(model = modw2,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                            "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                            "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                            "meritv03_pref_wpart","meritv03_pref_netw")) -->

<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Ordinal=fitmeasures(mod2_merit_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (DWLS)") -->
<!-- kable(standardizedsolution(mod2_merit_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->

<!-- > * Second order factor using MLR does not converge. -->
<!-- > * Second order factor using DWLS converges, but loads are not good and the fit is not. -->

<!-- # Summary fit indices wave 02 -->

<!-- ```{r} -->
<!-- sum_fitw02<- bind_rows(fitmeasures(fitw02a_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02a_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02b_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02b_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02_c)[ c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw02_o)[ c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],) -->

<!-- sum_fitw02$mod <- c("Model 1","Model 1","Model 2","Model 2","Model 3","Model 3","Model 4","Model 4") -->
<!-- sum_fitw02$est <- c("MLR","DWLS","MLR","DWLS","MLR","DWLS","MLR","DWLS") -->
<!-- sum_fitw02 <- select(sum_fitw02,mod,est,everything()) -->
<!-- colnames <- c("Model","Estimator","$\\chi^2$","df","CFI","CFI.sca","CFI.rob","RMSEA","RMSEA.sca","RMSEA.rob") -->


<!-- kable(sum_fitw02,digits = 3,format = "html",row.names = F,booktabs=T, caption = "Summary fit indices wave 02", col.names = colnames, escape = F) %>% -->
<!--   kable_styling(full_width = F) %>% -->
<!--   collapse_rows(columns = 1,valign = "middle") %>% -->
<!--   footnote(number = c("Model 1: Control group sample", -->
<!--                       "Model 2: Poverty treatment condition sample", -->
<!--                       "Model 3: Inequality treatment condition sample", -->
<!--                       "Model 4: Complete sample")) -->
<!-- ``` -->

<!-- # Wave 03 -->

<!-- ```{r} -->
<!-- data03 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola3.sav",verbose = FALSE) -->
<!-- dat01 <- data03 %>% select(starts_with("meritv03_p")) -->
<!-- ``` -->

<!-- ```{r echo=TRUE,results='asis'} -->
<!-- stargazer(dat01,type = "html", -->
<!--           title = "Descriptive statistics", -->
<!--           font.size = "small", -->
<!--           median = TRUE, -->
<!--           header=FALSE, -->
<!--           digit.separator = "", -->
<!--           digits = 2) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- model03 <- ' -->
<!-- perc_merit=~meritv03_perc_effort+meritv03_perc_talent -->
<!-- perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw -->
<!-- pref_merit=~meritv03_pref_effort+meritv03_pref_talent -->
<!-- pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw' -->

<!-- fitw03c_c <- cfa(model = model03,data = dat01,estimator="MLR") # Continuous/ estimator ML Robust -->

<!-- fitw03c_o <- cfa(model = model03,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent", -->
<!--                                                           "meritv03_perc_wpart","meritv03_perc_netw", -->
<!--                                                           "meritv03_pref_effort","meritv03_pref_talent", -->
<!--                                                           "meritv03_pref_wpart","meritv03_pref_netw")) -->
<!-- #---------------------------------------------------# -->
<!-- kable(rbind(Continuous=fitmeasures(fitw03c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--             Ordinal= fitmeasures(fitw03c_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]), -->
<!--       format = "markdown",digits = 3) -->

<!-- cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)") -->
<!-- kable(left_join(x = standardizedsolution(fitw03c_c) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 y = standardizedsolution(fitw03c_o) %>% filter(op=="=~") %>% select(lhs,rhs,est.std), -->
<!--                 c("lhs","rhs")), -->
<!--       format = "markdown",digits = 2,col.names = cnames) -->
<!-- ``` -->
<!-- **summary** -->

<!-- > * Adjustment using MLR estimator is good (CFI = 0.971, RMSEA = 0.052). The chi2 (robust) is 62,421 -->
<!-- > * Fit using DWLS estimator is good (CFI = 0.974, RMSEA = 0.067). The chi2 (robust) is 106,111 -->

<!-- # Summary fit indices wave 03 -->

<!-- ```{r} -->
<!-- sum_fitw03<- bind_rows(fitmeasures(fitw03c_c)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")], -->
<!--                        fitmeasures(fitw03c_o)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]) -->

<!-- sum_fitw03$mod <- c("Model 1","Model 1") -->
<!-- sum_fitw03$est <- c("Continuous","Ordinal") -->
<!-- sum_fitw03 <- select(sum_fitw03,mod,est,everything()) -->

<!-- kable(sum_fitw03,digits = 3,format = "html",row.names = F,booktabs=T,caption = "Summary fit indices wave 03") %>% -->
<!--   kable_styling(full_width = F) %>% -->
<!--   collapse_rows(columns = 1,valign = "middle") %>% -->
<!--   footnote(number = c("Model 1: Complete sample")) -->
<!-- ``` -->


```{r}
library(ggplot2)
library(reshape2)
library(sjPlot)
library(dplyr)

#install.packages("cowplot")
library(cowplot)

dat_merit <- dat04 %>% select("a.Effort"=perc_effort,"a.Talent"=perc_talent, "a.Rich Parents"=perc_wpart, "a.Contacts"=perc_netw, "b.Effort"=pref_effort,"b.Talent"=pref_talent,"b.Rich Parents"=pref_wpart, "b.Contacts"=pref_netw) 

  
plotlikert<-plot_likert(dat_merit, c(1,1,1,1,2,2,2,2),
            groups.titles = c("Perceptions","Preferences"),
            geom.colors ="PuBu", 
            axis.labels=c("Effort","Talent","Rich Parents","Contacts"),
            catcount = 4,
            cat.neutral = 3, 
            grid.range  =  c ( 1.2 , 1.4 ),
            values  =  "sum.outside",
            reverse.scale=TRUE)
plotlikert

ggsave(plotlikert,filename = "output/images/plotlikert.png",device = "png",width = 30,height = 15,dpi = "retina",units = "cm")


```



---
title: "Analysis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
css: ../style.css
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
    toc_depth: 4
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
---

# Análisis PPM-S

# Wave 01

```{r eval=FALSE, include=FALSE}
rmarkdown::render(input = "production/analysis-cfa.Rmd",output_format = "html_document")
```

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
```

```{r}
library(sjPlot)
library(dplyr)
library(lavaan)
library(stargazer)
library(corrplot)
library(psych)
library(knitr)
library(kableExtra)
```


```{r}
data01 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola1.sav",verbose = FALSE)

dat01 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv01")) %>% na.omit()
dat02 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv02")) %>% na.omit()
dat03 <- data01 %>% filter(Intro==1,Finished==1) %>% select(starts_with("meritv03_p")) %>% na.omit()

# - Nos quedamos solamente con los casos que ACEPTARON participar y terminaron el cuestionario.
# - Para dejar una base que contenga solamente los casos que tienen información completa en los ítems usamos na.omit()

dat04 <- data01 %>% filter(Intro==1) %>%
  select(starts_with("meritv01"),
         starts_with("meritv02"),
         starts_with("meritv03_p"),
         starts_with("FL_21_DO")) 
dat04$grupo <- NA
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v01==1] <- 1
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v02==1] <- 2
dat04$grupo[dat04$FL_21_DO_merit_perc_pref_julio19v03==1] <- 3
dat04$perc_effort <- rowSums(dat04[,c(matches(match = "perc_effort",vars = names(dat04)))],na.rm = TRUE)
dat04$perc_talent <- rowSums(dat04[,c(matches(match = "perc_talent",vars = names(dat04)))],na.rm = TRUE)
dat04$perc_wpart  <- rowSums(dat04[,c(matches(match = "perc_wpart" ,vars = names(dat04)))],na.rm = TRUE)
dat04$perc_netw   <- rowSums(dat04[,c(matches(match = "perc_netw"  ,vars = names(dat04)))],na.rm = TRUE)

dat04$pref_effort <- rowSums(dat04[,c(matches(match = "pref_effort",vars = names(dat04)))],na.rm = TRUE)
dat04$pref_talent <- rowSums(dat04[,c(matches(match = "pref_talent",vars = names(dat04)))],na.rm = TRUE)
dat04$pref_wpart  <- rowSums(dat04[,c(matches(match = "pref_wpart" ,vars = names(dat04)))],na.rm = TRUE)
dat04$pref_netw   <- rowSums(dat04[,c(matches(match = "pref_netw"  ,vars = names(dat04)))],na.rm = TRUE)
dat04[dat04==0] <- NA
```

## Version 01: Fixed order by perception / preferences (N=`r dim(dat01)[1]`)

1. Percepcion esfuerzo
2. Percepcion talento
3. Percepcion familia rica
4. Percepcion redes
5. Preferencia esfuerzo
6. Preferencia talento
7. Preferencia familia rica
8. Preferencia redes

```{r echo=FALSE,results='asis'}
stargazer(dat01,type = "html")
```

```{r correlacion v01}
cor01<-polychoric(dat01)
corrplot(cor01$rho,method = "color" ,type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

```{r}
model01 <- '
perc_merit=~meritv01_perc_effort+meritv01_perc_talent 
perc_nmerit=~meritv01_perc_wpart+meritv01_perc_netw  
pref_merit=~meritv01_pref_effort+meritv01_pref_talent 
pref_nmerit=~meritv01_pref_wpart+meritv01_pref_netw'

fit1_c <- cfa(model = model01,data = dat01,estimator="MLR") # Continuo/ estimador ML Robust

fit1_o <- cfa(model = model01,data = dat01,
            ordered = c("meritv01_perc_effort","meritv01_perc_talent",
                        "meritv01_perc_wpart","meritv01_perc_netw",
                        "meritv01_pref_effort","meritv01_pref_talent",
                        "meritv01_pref_wpart","meritv01_pref_netw"))

#---------------------------------------------------#
# #summary(fit1_c,standardized=TRUE, fit.measures=TRUE)}
fitmeasures(fit1_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit1_c,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)

# #summary(fit1_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit1_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit1_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)
```

> *#summary*: good fit, heywood case item 8.

## Version 02: Fixed order, by topic (N=`r dim(dat02)[1]`)

1. Percepcion esfuerzo
2. Preferencia esfuerzo
3. Percepcion talento
4. Preferencia talento
5. Percepcion familia rica
6. Preferencia familia rica
7. Percepcion redes
8. Preferencia redes

```{r echo=FALSE,results='asis'}
stargazer(dat02,type = "html")
```


```{r}
cor02<-polychoric(dat02)
corrplot(cor02$rho,method = "color", type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```


```{r,results='hold'}
model02 <- '
perc_merit=~meritv02_perc_effort+meritv02_perc_talent 
perc_nmerit=~meritv02_perc_wpart+meritv02_perc_netw  
pref_merit=~meritv02_pref_effort+meritv02_pref_talent 
pref_nmerit=~meritv02_pref_wpart+meritv02_pref_netw'

fit2_c <- cfa(model = model02,data = dat02,estimator="MLR") # Continuo/ estimador ML Robust

fit2_o <- cfa(model = model02,data = dat02,ordered = c("meritv02_perc_effort","meritv02_perc_talent",
                                                     "meritv02_perc_wpart","meritv02_perc_netw",
                                                     "meritv02_pref_effort","meritv02_pref_talent",
                                                     "meritv02_pref_wpart","meritv02_pref_netw"))

#---------------------------------------------------#
#summary(fit2_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit2_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit2_c,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)

#summary(fit2_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit2_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit2_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)
```
> **NOTA**: bad fit, heywood en estimación DWLS

## Version 03: Random order (N=`r dim(dat03)[1]`)

```{r echo=FALSE,results='asis'}
stargazer(dat03,type = "html")
```

```{r}
cor03<-polychoric(dat03)
corrplot(cor03$rho,method = "color", type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fit3_c <- cfa(model = model03,data = dat03,estimator="MLR",std.lv=FALSE) # Continuo/ estimador ML Robust

fit3_o <- cfa(model = model03,data = dat03,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                       "meritv03_perc_wpart","meritv03_perc_netw",
                                                       "meritv03_pref_effort","meritv03_pref_talent",
                                                       "meritv03_pref_wpart","meritv03_pref_netw"),std.lv=FALSE)
#---------------------------------------------------#
#summary(fit3_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit3_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_c,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)

#summary(fit3_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit3_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)
```

> **NOTA**: fit not very goood (RMSEA .7), no heywood. Try tau-equivalence

```{r,results='hold'}
model03.tau <- '
perc_merit=~ r1*meritv03_perc_effort+r1*meritv03_perc_talent 
perc_nmerit=~r2*meritv03_perc_wpart+ r2*meritv03_perc_netw  
pref_merit=~ r3*meritv03_pref_effort+r3*meritv03_pref_talent 
pref_nmerit=~r4*meritv03_pref_wpart+ r4*meritv03_pref_netw'

fit3_c.tau <- cfa(model = model03.tau,data = dat03,estimator="MLR",std.lv=FALSE) # Continuo/ estimador ML Robust

fit3_o.tau <- cfa(model = model03.tau,data = dat03,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                               "meritv03_perc_wpart","meritv03_perc_netw",
                                                               "meritv03_pref_effort","meritv03_pref_talent",
                                                               "meritv03_pref_wpart","meritv03_pref_netw"), std.lv=FALSE)
#---------------------------------------------------#
#summary(fit3_c.tau,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit3_c.tau)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_c.tau,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)

#summary(fit3_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit3_o.tau)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_o.tau,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve = 1.5)
```

```{r}
rbind(fitmeasures(fit3_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
      fitmeasures(fit3_o.tau)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")])
anova(fit3_o,fit3_o.tau)
```

> **NOTA:** El modelo con igualdad de cargas factoriales no deteriora significativamente el ajuste del modelo.

## Version 04: muestra completa (N=`r dim(dat04)[1]`)

```{r echo=FALSE,results='asis'}
stargazer(select(dat04,perc_effort,perc_talent,perc_wpart,perc_netw,pref_effort,pref_talent,pref_wpart,pref_netw),
          type = "html")
```

```{r}
cor04<-polychoric(select(dat04,perc_effort,perc_talent,perc_wpart,perc_netw,pref_effort,pref_talent,pref_wpart,pref_netw))
corrplot(cor04$rho, method="color",type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model04 <- '
perc_merit =~ perc_effort+perc_talent 
perc_nmerit=~perc_wpart +perc_netw  
pref_merit =~ pref_effort+pref_talent 
pref_nmerit=~pref_wpart +pref_netw'

fit4_c <- cfa(model = model04,data = dat04,estimator="MLR",std.lv=FALSE) # Continuo/ estimador ML Robust

fit4_o <- cfa(model = model04,data = dat04,ordered = c("perc_effort","perc_talent",
                                                       "perc_wpart","perc_netw",
                                                       "pref_effort","pref_talent",
                                                       "pref_wpart","pref_netw"),std.lv=FALSE)
#---------------------------------------------------#
#summary(fit4_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_c,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE,curve = 2)

#summary(fit4_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit3_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE,curve = 2)
```

### Resumen ajuste ola 01

```{r}
sum_fit<- bind_rows(fitmeasures(fit1_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit1_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit2_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit2_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit3_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit3_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit4_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                    fitmeasures(fit4_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")])
sum_fit$mod <- c("Modelo 1","Modelo 1","Modelo 2","Modelo 2","Modelo 3","Modelo 3","Modelo 4","Modelo 4")
sum_fit$est <- c("Continuo","Ordinal","Continuo","Ordinal","Continuo","Ordinal","Continuo","Ordinal")
sum_fit <- select(sum_fit,mod,est,everything())

kable(sum_fit,digits = 3,format = "html",row.names = F,booktabs=T, caption = "Resumen estadísticos de ajuste ola 1") %>% kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1,valign = "middle")  %>% 
  footnote(number = c("Modelo 1: fixed order by percepction/preference", 
                      "Modelo 2: fixed order by topic (i.e: effort)", 
                      "Modelo 3: Randomized order",
                      "Modelo 4: Complete sample"))
```

## Análisis por Grupos múltiples

```{r}
model04 <- '
perc_merit =~ perc_effort+perc_talent 
perc_nmerit=~perc_wpart +perc_netw  
pref_merit =~ pref_effort+pref_talent 
pref_nmerit=~pref_wpart +pref_netw'

fit4_c_mg <- cfa(model = model04,data = dat04,estimator="MLR",std.lv=FALSE,group = "grupo") # Continuo/ estimador ML Robust

fit4_o_mg <- cfa(model = model04,data = dat04,ordered = c("perc_effort","perc_talent",
                                                       "perc_wpart","perc_netw",
                                                       "pref_effort","pref_talent",
                                                       "pref_wpart","pref_netw"),std.lv=FALSE, group = "grupo")
#---------------------------------------------------#
#summary(fit4_c_mg,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4_c_mg)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit4_c_mg,what = "std",thresholds = FALSE, intercepts = FALSE, fade=FALSE, curve=2)

#summary(fit4_o_mg,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4_o_mg)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit4_o_mg,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve=2)
```

Cosas por probar:

* V01+V02: cargas y fit
* V01+V03: cargas y fit
* V02+V03: cargas y fit

# Modelo Factorial de Segundo Orden:

## a. Factor de segundo orden por Percepción y Preferencia

```{r}
model04b1or <- '
perc_merit=~ perc_effort+perc_talent 
perc_nmerit=~perc_wpart +perc_netw  
pref_merit=~ pref_effort+pref_talent 
pref_nmerit=~pref_wpart +pref_netw
percep=~ perc_merit + perc_nmerit
prefer=~ pref_merit + pref_nmerit'

fit4a_c <- cfa(model = model04b1or,data = dat04, estimator="MLR")

fit4b_c <- cfa(model = model04b1or,data = dat04,ordered = c("perc_effort","perc_talent","perc_wpart","perc_netw",
                                                            "pref_effort","pref_talent","pref_wpart","pref_netw"))

#---------------------------------------------------#
#summary(fit4a_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4a_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit4a_c,what = "std",thresholds = FALSE, intercepts = FALSE, fade=FALSE,curve=2)

#summary(fit4b_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4b_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit4b_c,what = "std",thresholds = FALSE, intercepts = FALSE, fade=FALSE,curve=2)
```

> **NOTA:** Cargas factoriales de segundo orden son bajas. El ajuste del modelo no es bueno.

## b. Factor de segundo orden por Meritocracia y No Meritocracia

```{r}
model04b2or <-'perc_merit=~ perc_effort+perc_talent
               perc_nmerit=~perc_wpart +perc_netw
               pref_merit=~ pref_effort+pref_talent
               pref_nmerit=~pref_wpart +pref_netw
               merit =~ perc_merit  + pref_merit
               nmerit=~ perc_nmerit + pref_nmerit'

# fit4b_c <- cfa(model = model04b2or,data = dat04,estimator="MLR") # No converge

fit4b_o <- cfa(model = model04b2or,data = dat04, 
               ordered = c("perc_effort","perc_talent","perc_wpart","perc_netw",
                           "pref_effort","pref_talent","pref_wpart","pref_netw"))

#---------------------------------------------------#
# #summary(fit4b_c,standardized=TRUE, fit.measures=TRUE)
# fitmeasures(fit4b_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
# semPlot::semPaths(object = fit4b_c,what = "std",thresholds = FALSE, intercepts = FALSE, fade=FALSE, curve=2)

#summary(fit4b_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fit4b_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fit4b_o,what = "std",thresholds = FALSE, intercepts = FALSE, fade=FALSE, curve=2)
```

> **NOTA:** El modelo estimado con MLR con factores de segundo orden "meritocracia/ no meritocracia" no converge. EL modelo estimado a través de DWLS converge, posee cargas muy bajas y una muy alta (merit~pref_merit). Fit es malo (RMSEA >.10)


# Wave 02

```{r}
data02 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola2.sav",verbose = FALSE)
load(file = "input/data/proc/datawide.RData")
dat01 <- data02 %>% select(starts_with("meritv03_p")) 
```

## ATE indicadores meritocracia

```{r, out.width="75%", results='asis'}
m01<- lm(perc_effort_w2~treat,data = wide01)
m02<- lm(perc_talent_w2~treat,data = wide01)
m03<- lm(perc_wpart_w2~treat, data = wide01)
m04<- lm(perc_netw_w2~treat,  data = wide01)
#--------------------------------------------#
m05<- lm(pref_effort_w2~treat,data = wide01)
m06<- lm(pref_talent_w2~treat,data = wide01)
m07<- lm(pref_wpart_w2 ~treat, data = wide01)
m08<- lm(pref_netw_w2  ~treat,  data = wide01)
#--------------------------------------------#
stargazer::stargazer(m01,m02,m03,m04,type = "html")
stargazer::stargazer(m05,m06,m07,m08,type = "html")
```

> **NOTA**: Los tratamientos de información no se asocian de manera estadísticamente significativa con ninguno de los indicadores de la escala de meritocracia.  

## CFA Muestra completa (Control, Desigualdad y Pobreza) 

```{r echo=FALSE,results='asis'}
stargazer(dat01,type = "html")
```

```{r}
dat01cor<- select(dat01,meritv03_perc_effort,meritv03_perc_talent,
                        meritv03_perc_wpart,meritv03_perc_netw,
                        meritv03_pref_effort,meritv03_pref_talent,
                        meritv03_pref_wpart,meritv03_pref_netw)
cor01<-polychoric(dat01cor)
corrplot(cor01$rho, type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```


```{r,results='hold'}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fitw02_c <- cfa(model = model03,data = dat01,estimator="MLR",std.lv=FALSE) # Continuo/ estimador ML Robust

fitw02_o <- cfa(model = model03,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                          "meritv03_perc_wpart","meritv03_perc_netw",
                                                          "meritv03_pref_effort","meritv03_pref_talent",
                                                          "meritv03_pref_wpart","meritv03_pref_netw"))
#---------------------------------------------------#
#summary(fitw02_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02_c,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE,curve=2)

#summary(fitw02_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE,curve=2)
```

> **NOTA**: El ajuste de muestra completa en wave 02 con estimador MLR (robusto) es bastante bueno (CFI, RMSEA). El ajuste con DWLS es bastante bueno, CFI mejora, RMSEA aumenta un poco (0.59). 

* **Recomendación**: es probable que el estimador MLR sea mejor que el ordinal. 

### Factor de segundo orden

```{r}
modw2 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw 
merit =~perc_merit+pref_merit  
nmerit=~perc_nmerit+pref_nmerit'

# mod2_merit_c <- cfa(model = modw2,data = dat01) # Continuo/ estimador ML Robust

mod2_merit_o <- cfa(model = modw2,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                           "meritv03_perc_wpart","meritv03_perc_netw",
                                                           "meritv03_pref_effort","meritv03_pref_talent",
                                                           "meritv03_pref_wpart","meritv03_pref_netw"))

#---------------------------------------------------#
# #summary(mod2_merit_c,standardized=TRUE, fit.measures=TRUE)
# fitmeasures(mod2_merit_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
# semPlot::semPaths(object = mod2_merit_c,what = "std",thresholds = FALSE, intercepts = FALSE)

#summary(mod2_merit_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(mod2_merit_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = mod2_merit_o,what = "std",thresholds = FALSE, intercepts = FALSE,fade=FALSE, curve=2, rotation=2)
```

> * Factor de segundo orden usando MLR no converge.
> * Factor de segundo orden usando DWLS converge, pero las cargas no son buenas y el ajuste tampoco.

## CFA Muestra Control

```{r}
w02con <- data02 %>% filter(FL_6_DO_Control==1) %>% select(starts_with("meritv03_p")) 
```

```{r echo=FALSE,results='asis'}
stargazer(w02con,type = "html")
```

```{r}
corw02_1<-polychoric(w02con)
corrplot(corw02_1$rho, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```


```{r,results='hold'}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fitw02a_c <- cfa(model = model03,data = w02con,estimator="MLR") # Continuo/ estimador ML Robust

fitw02a_o <- cfa(model = model03,data = w02con,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                           "meritv03_perc_wpart","meritv03_perc_netw",
                                                           "meritv03_pref_effort","meritv03_pref_talent",
                                                           "meritv03_pref_wpart","meritv03_pref_netw"))

#---------------------------------------------------#
#summary(fitw02a_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02a_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02a_c,what = "std",thresholds = FALSE, intercepts = FALSE, curve=2)

#summary(fitw02a_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02a_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02a_o,what = "std",thresholds = FALSE, intercepts = FALSE, curve=2)
```

## CFA Muestra Pobreza

```{r}
w02pob <- data02 %>% filter(FL_6_DO_Tratamiento==1) %>% select(starts_with("meritv03_p")) 
```

```{r echo=FALSE,results='asis'}
stargazer(w02pob,type = "html")
```

```{r}
corw02_2<-polychoric(w02pob)
corrplot(corw02_2$rho, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fitw02b_c <- cfa(model = model03,data = w02pob,estimator="MLR") # Continuo/ estimador ML Robust

fitw02b_o <- cfa(model = model03,data = w02pob,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                     "meritv03_perc_wpart","meritv03_perc_netw",
                                                     "meritv03_pref_effort","meritv03_pref_talent",
                                                     "meritv03_pref_wpart","meritv03_pref_netw"))

#---------------------------------------------------#
#summary(fitw02b_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02b_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02b_c,what = "std",thresholds = FALSE, intercepts = FALSE, curve=2)

#summary(fitw02b_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02b_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02b_o,what = "std",thresholds = FALSE, intercepts = FALSE, curve=2)
```

## CFA Muestra Desigualdad 

```{r}
w02des <- data02 %>% filter(FL_6_DO_Tratamiento_desigualdad==1) %>% select(starts_with("meritv03_p")) 
```

```{r echo=FALSE,results='asis'}
stargazer(w02des,type = "html")
```

```{r}
corw02_3<-polychoric(w02des)
corrplot(corw02_3$rho, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

```{r,results='hold'}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fitw02c_c <- cfa(model = model03,data = w02des,estimator="MLR") # Continuo/ estimador ML Robust

fitw02c_o <- cfa(model = model03,data = w02des,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                           "meritv03_perc_wpart","meritv03_perc_netw",
                                                           "meritv03_pref_effort","meritv03_pref_talent",
                                                           "meritv03_pref_wpart","meritv03_pref_netw"))
#---------------------------------------------------#
#summary(fitw02c_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02c_c,what = "std",thresholds = FALSE, intercepts = FALSE)

#summary(fitw02b_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw02c_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitw02c_o,what = "std",thresholds = FALSE, intercepts = FALSE)
```

# Resumen ajuste ola 2
```{r}
sum_fitw02<- bind_rows(fitmeasures(fitw02_c)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02_o)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02a_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02a_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02b_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02b_o)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02c_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw02c_c)[c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")])

sum_fitw02$mod <- c("Modelo 1","Modelo 1","Modelo 2","Modelo 2","Modelo 3","Modelo 3","Modelo 4","Modelo 4")
sum_fitw02$est <- c("Continuo","Ordinal","Continuo","Ordinal","Continuo","Ordinal","Continuo","Ordinal")
sum_fitw02 <- select(sum_fitw02,mod,est,everything())

kable(sum_fitw02,digits = 3,format = "html",row.names = F,booktabs=T, caption = "Resumen ajuste ola 2") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1,valign = "middle") %>% 
  footnote(number = c("Modelo 1: Muestra completa", 
                      "Modelo 2: Muestra grupo Control", 
                      "Modelo 3: Muestra grupo tratamiento pobreza",
                      "Modelo 4: Muestra grupo tratamiento desigualdad"))
```

# Wave 03

```{r}
data03 <- sjlabelled::read_spss(path = "input/data/original/Estudio_3_ola3.sav",verbose = FALSE)
dat01 <- data03 %>% select(starts_with("meritv03_p")) 
```

```{r}
sjt.fa(data = dat01,show.comm = TRUE)
```

```{r}
model03 <- '
perc_merit=~meritv03_perc_effort+meritv03_perc_talent 
perc_nmerit=~meritv03_perc_wpart+meritv03_perc_netw  
pref_merit=~meritv03_pref_effort+meritv03_pref_talent 
pref_nmerit=~meritv03_pref_wpart+meritv03_pref_netw'

fitw03c_c <- cfa(model = model03,data = dat01,estimator="MLR") # Continuo/ estimador ML Robust

fitw03c_o <- cfa(model = model03,data = dat01,ordered = c("meritv03_perc_effort","meritv03_perc_talent",
                                                          "meritv03_perc_wpart","meritv03_perc_netw",
                                                          "meritv03_pref_effort","meritv03_pref_talent",
                                                          "meritv03_pref_wpart","meritv03_pref_netw"))
#---------------------------------------------------#
#summary(fitw03c_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw03c_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]

#summary(fitw03c_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitw03c_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
```
**summary**
> * Ajuste usando estimador MLR  es bueno (CFI = 0.971, RMSEA = 0.052). El chi2 (robusto) es 62.421  
> * Ajuste usando estimador DWLS es bueno (CFI = 0.974, RMSEA = 0.067). El chi2 (robusto) es 106.111

# Resumen ajuste ola 3

```{r}
sum_fitw03<- bind_rows(fitmeasures(fitw03c_c)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")],
                       fitmeasures(fitw03c_o)[ c("cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")])

sum_fitw03$mod <- c("Modelo 1","Modelo 1")
sum_fitw03$est <- c("Continuo","Ordinal")
sum_fitw03 <- select(sum_fitw03,mod,est,everything())

kable(sum_fitw03,digits = 3,format = "html",row.names = F,booktabs=T,caption = "Resumen ajuste ola 3") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1,valign = "middle") %>% 
  footnote(number = c("Modelo 1: Muestra completa"))
```

# Análisis longitudinal

```{r}
library(sjPlot)
library(dplyr)
library(lavaan)
library(stargazer)
library(corrplot)
library(psych)
library(knitr)
library(kableExtra)
load(file = "input/data/proc/datawide_123.RData")
```

## Correlación indicadores w01 y w02

```{r}
g01<- wide02 %>% filter(grupo==1) %>% select(starts_with("perc_"),starts_with("pref_")) # Fixed by perception/preference
g02<- wide02 %>% filter(grupo==2) %>% select(starts_with("perc_"),starts_with("pref_")) # Fixed by topic (i.e: effort)
g03<- wide02 %>% filter(grupo==3) %>% select(starts_with("perc_"),starts_with("pref_")) # Randomized
```

### Grupo Versión 01

```{r, out.width="75%", results='asis'}
stargazer(g01,type = "html", median = T,digits = 2)
```

```{r, out.width=c("75%","75%"), fig.cap=c("Percepción","Preferencia"), fig.align='center'}
corwide01a<- polychoric(x = select(g01 ,starts_with(match = "perc_")),na.rm = T)
corrplot(corwide01a$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)

corwide01b<- polychoric(x = select(g01 ,starts_with(match = "pref_")),na.rm = T)
corrplot(corwide01b$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

### Grupo Versión 02 

```{r, out.width="75%", results='asis'}
stargazer(g02,type = "html", median = T,digits = 2)
```

```{r, out.width=c("75%","75%"), fig.cap=c("Percepción","Preferencia"), fig.align='center'}
corwide02a<- polychoric(x = select(g02 ,starts_with(match = "perc_")),na.rm = T)
corrplot(corwide02a$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)

corwide02b<- polychoric(x = select(g02 ,starts_with(match = "pref_")),na.rm = T)
corrplot(corwide02b$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

### Grupo Versión 03

```{r, results='asis'}
stargazer(g03,type = "html", median = T,digits = 2)
```

```{r, out.width=c("75%","75%"), fig.cap=c("Percepción","Preferencia"), fig.align='center'}
corwide03a<- polychoric(x = select(g03 ,starts_with(match = "perc_")),na.rm = T)
corrplot(corwide03a$rho, type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE,tl.cex = 0.75)

corwide03b<- polychoric(x = select(g03 ,starts_with(match = "pref_")),na.rm = T)
corrplot(corwide03b$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

### Muestra completa 

```{r, results='asis'}
stargazer(select(wide02 ,starts_with(match = "perc_"), starts_with("pref_")),type = "html", median = T,digits = 2)
```

```{r, out.width=c("75%","75%"), fig.cap=c("Percepción","Preferencia"), fig.align='center'}
corwideA<- polychoric(x = select(wide02 ,starts_with(match = "perc_")),na.rm = T)
corrplot(corwideA$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)

corwideB<- polychoric(x = select(wide02 ,starts_with(match = "pref_")),na.rm = T)
corrplot(corwideB$rho, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

## CFA wave01, wave02 y wave03

```{r}
model_long <- '
# wave 01
perc_merit1 =~perc_effort_w1+perc_talent_w1 
perc_nmerit1=~perc_wpart_w1 +perc_netw_w1  
pref_merit1 =~pref_effort_w1+pref_talent_w1 
pref_nmerit1=~pref_wpart_w1 +pref_netw_w1
# wave 02
perc_merit2 =~perc_effort_w2+perc_talent_w2 
perc_nmerit2=~perc_wpart_w2 +perc_netw_w2  
pref_merit2 =~pref_effort_w2+pref_talent_w2 
pref_nmerit2=~pref_wpart_w2 +pref_netw_w2
# wave 03
perc_merit3 =~perc_effort_w3+perc_talent_w3 
perc_nmerit3=~perc_wpart_w3 +perc_netw_w3  
pref_merit3 =~pref_effort_w3+pref_talent_w3 
pref_nmerit3=~pref_wpart_w3 +pref_netw_w3'


fitlong_c <- cfa(model = model_long,data = wide02,estimator="MLR") # Continuo/ estimador ML Robust

indicadores <-c("perc_effort_w1","perc_talent_w1","perc_wpart_w1","perc_netw_w1",
                "pref_effort_w1","pref_talent_w1","pref_wpart_w1","pref_netw_w1",
                "perc_effort_w2","perc_talent_w2","perc_wpart_w2","perc_netw_w2",
                "pref_effort_w2","pref_talent_w2","pref_wpart_w2","pref_netw_w2")  

fitlong_o <- cfa(model = model_long,data = wide02,ordered = indicadores)

#---------------------------------------------------#
#summary(fitlong_c,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitlong_c)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitlong_c,what = "std",thresholds = FALSE, intercepts = FALSE)

#summary(fitlong_o,standardized=TRUE, fit.measures=TRUE)
fitmeasures(fitlong_o)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
semPlot::semPaths(object = fitlong_o,what = "std",thresholds = FALSE, intercepts = FALSE,style = "mx")
```

```{r,fig.cap="Correlación entre variables latentes w01, w02 y w03"}
cormat<- as.matrix(inspect(fitlong_o, "cor.lv"))
corrplot(cormat, method = "color" ,type = "upper", tl.col = "black", tl.srt = 45,addCoef.col = "black",diag = FALSE)
```

# Invarianza

1. Invarianza entre modalidades en ola 1,2 y 3 (between groups invariance)
2. Invarianza entre tratamientos en ola 2(between groups invariance)

>**NOTA**: En vista de que no existe una librería que permita estimar invarianza longitudinal asumiendo indicadores ordinales, las primeras estimaciones las realizaré asumiendo indicadores continuos (estimator=ML).

```{r}
library(semTools)
```

```{r}
load(file = "input/data/proc/datalong.RData")     # Datos formato long
load(file = "input/data/proc/datawide_123.RData") # Datos formato long
```

```{r}
dim(dat04)
m_inv_modalidad <- 'perc_merit=~ perc_effort+perc_talent 
                    perc_nmerit=~perc_wpart +perc_netw  
                    pref_merit=~ pref_effort+pref_talent 
                    pref_nmerit=~pref_wpart +pref_netw'

indicators  <-c("perc_effort","perc_talent","perc_wpart","perc_netw",
                "pref_effort","pref_talent","pref_wpart","pref_netw")  

fit.conf=cfa(m_inv_modalidad,data=dat04,group="grupo")
fit.deb =cfa(m_inv_modalidad,data=dat04,group="grupo",group.equal=c("loadings"))
fit.fuer=cfa(m_inv_modalidad,data=dat04,group="grupo",group.equal=c("loadings","intercepts"))
fit.str =cfa(m_inv_modalidad,data=dat04,group="grupo",group.equal=c("loadings","intercepts","residuals"))


fitmeasures(fit.conf)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
fitmeasures(fit.deb )[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
fitmeasures(fit.fuer)[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
fitmeasures(fit.str )[c("chisq.scaled","df","cfi","cfi.scaled","cfi.robust","rmsea","rmsea.scaled","rmsea.robust")]
anova(fit.conf, fit.deb, fit.fuer, fit.str)
```

```{r}
configural <- '
# wave 01
perc_merit1 =~NA*perc_effort_w1+lambda1*perc_effort_w1+perc_talent_w1 
perc_nmerit1=~NA*perc_wpart_w1 +lambda1*perc_wpart_w1 +perc_netw_w1  
pref_merit1 =~NA*pref_effort_w1+lambda1*pref_effort_w1+pref_talent_w1 
pref_nmerit1=~NA*pref_wpart_w1 +lambda1*pref_wpart_w1 +pref_netw_w1
# wave 02
perc_merit2 =~NA*perc_effort_w2+lambda1*perc_effort_w2+perc_talent_w2 
perc_nmerit2=~NA*perc_wpart_w2 +lambda1*perc_wpart_w2 +perc_netw_w2  
pref_merit2 =~NA*pref_effort_w2+lambda1*pref_effort_w2+pref_talent_w2 
pref_nmerit2=~NA*pref_wpart_w2 +lambda1*pref_wpart_w2 +pref_netw_w2
# wave 03
perc_merit3 =~NA*perc_effort_w3+lambda1*perc_effort_w3+perc_talent_w3 
perc_nmerit3=~NA*perc_wpart_w3 +lambda1*perc_wpart_w3 +perc_netw_w3  
pref_merit3 =~NA*pref_effort_w3+lambda1*pref_effort_w3+pref_talent_w3 
pref_nmerit3=~NA*pref_wpart_w3 +lambda1*pref_wpart_w3 +pref_netw_w3

# INTERCEPTS: Por cada variable latente, debo fijar el intercepto del primer indicador.
# wave 01--------------------------
perc_effort_w1 ~ i1*1   # Percepcion merito        
perc_talent_w1 ~ 1      #      
perc_wpart_w1 ~ i1*1    # Percepcion no-merito   
perc_netw_w1 ~ 1        #
pref_effort_w1 ~ i1*1   # Preferencia merito    
pref_talent_w1 ~ 1      #  
pref_wpart_w1 ~ i1*1    # Preferencia no-merito   
pref_netw_w1 ~ 1        #

# wave 02--------------------------
perc_effort_w2 ~ i1*1   # Percepcion merito                    
perc_talent_w2 ~ 1      #               
perc_wpart_w2 ~ i1*1    # Percepcion no-merito              
perc_netw_w2 ~ 1        #       
pref_effort_w2 ~ i1*1   # Preferencia merito                
pref_talent_w2 ~ 1      #           
pref_wpart_w2 ~ i1*1    # Preferencia no-merito              
pref_netw_w2 ~ 1        #       
               
# wave 03--------------------------
perc_effort_w3 ~ i1*1   # Percepcion merito                     
perc_talent_w3 ~ 1      #                            
perc_wpart_w3 ~ i1*1    # Percepcion no-merito                
perc_netw_w3 ~ 1        #                  
pref_effort_w3 ~ i1*1   # Preferencia merito                   
pref_talent_w3 ~ 1      #                        
pref_wpart_w3 ~ i1*1    # Preferencia no-merito               
pref_netw_w3 ~ 1        #

# UNIQUE VARIANCES and COVARIANCES.


# LATENT VARIABLES MEANS: Para cada variable latente fijar la media
# Fix T1 common factor mean to zero
perc_merit1 ~ 0*1
# Freely estimate T2-T3 common factor means
perc_merit2 ~ 1
perc_merit3 ~ 1

perc_nmerit1 ~ 0*1
perc_nmerit2 ~ 1
perc_nmerit3 ~ 1

pref_merit1 ~ 0*1
pref_merit2 ~ 1
pref_merit3 ~ 1

pref_nmerit1 ~ 0*1
pref_nmerit2 ~ 1
pref_nmerit3 ~ 1

# LATENT VARIABLE VARIANCES AND COVARIANCES: correlaciones entre variables latentes

'                   

fit_conf <- cfa(model = configural,data =wide02)
summary(fit_conf, standardized=TRUE)
```



* Invarianza Longitudinal en lavaan
https://quantdev.ssri.psu.edu/tutorials/intro-basics-longitudinal-measurement-invariance 

* https://users.ugent.be/~yrosseel/lavaan/multiplegroup6Dec2012.pdf 

* Invarianza con indicadores categóricos
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5121102/pdf/nihms757737.pdf

* Parametrización tetha: 
https://groups.google.com/forum/#!topic/lavaan/nfdatPgLLhc

* Colapsing categories:
https://www.tandfonline.com/doi/abs/10.1080/10705511.2018.1547640?journalCode=hsem20








